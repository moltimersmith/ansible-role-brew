---
- name: Preflight | optionally require macOS
  ansible.builtin.assert:
    that:
      - ansible_system == 'Darwin'
    fail_msg: "brew role currently targets macOS (Darwin) hosts. ansible_system={{ ansible_system }}"
  when: brew_require_macos | bool

- name: Preflight | locate brew
  ansible.builtin.shell: |
    set -euo pipefail
    export PATH="{{ brew_default_path }}:$PATH"
    command -v brew
  args:
    executable: /bin/bash
  register: brew_path
  changed_when: false

- name: Preflight | ensure brew is installed
  ansible.builtin.assert:
    that:
      - brew_path.stdout | length > 0
    fail_msg: |
      Homebrew (brew) was not found on the target host.
      Make sure Homebrew is installed and that it is reachable in non-interactive sessions.
      Tried PATH={{ brew_default_path }}:$PATH

- name: Set brew_bin fact
  ansible.builtin.set_fact:
    brew_bin: "{{ brew_path.stdout }}"

- name: Update brew (optional)
  ansible.builtin.command: "{{ brew_bin }} update"
  when: brew_update | bool

- name: Ensure taps are present
  community.general.homebrew_tap:
    name: "{{ item }}"
    state: present
    path: "{{ brew_bin }}"
  loop: "{{ brew_taps }}"
  when: brew_taps | length > 0

- name: Ensure formulae are installed
  community.general.homebrew:
    name: "{{ brew_formulae }}"
    state: present
    path: "{{ brew_bin }}"
  when: brew_formulae | length > 0

- name: Ensure casks are installed
  community.general.homebrew_cask:
    name: "{{ brew_casks }}"
    state: present
    path: "{{ brew_bin }}"
  when: brew_casks | length > 0
